# apps/orchestrator/Dockerfile
# =================================================================
# APARATO: BACKEND ORCHESTRATOR
# CLASIFICACI√ìN: PRODUCTION / RENDER DEPLOY
# ARQUITECTURA: MULTI-STAGE BUILD (Rust + Debian Slim)
# =================================================================

# -----------------------------------------------------------------
# ETAPA 1: BUILDER (Compilaci√≥n y Enlazado)
# -----------------------------------------------------------------
FROM rust:1.83-slim-bookworm as builder

# Directorio de trabajo en el contenedor de construcci√≥n
WORKDIR /usr/src/app

# 1.1. Instalaci√≥n de dependencias del sistema necesarias para compilar
# - pkg-config & libssl-dev: Para compilar criptograf√≠a (OpenSSL/reqwest)
# - curl & git: Para descargar dependencias y el √≠ndice de crates
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get install -y pkg-config libssl-dev curl git && \
    rm -rf /var/lib/apt/lists/*

# 1.2. Copia del Contexto del Monorepo
# Copiamos TODO (.) porque el build necesita acceso al workspace completo
# (libs/core, libs/domain, Cargo.toml ra√≠z, etc.)
COPY . .

# 1.3. Diagn√≥stico de Entorno
RUN echo "üèóÔ∏è  Iniciando compilaci√≥n del Orquestador..." && \
    rustc --version

# 1.4. Compilaci√≥n Release
# NOTA DE INGENIER√çA:
# - Se ha eliminado '--locked' para permitir la actualizaci√≥n del Cargo.lock
#   dentro del contenedor, corrigiendo la desincronizaci√≥n de dependencias.
# - '-p prospector-orchestrator': Compila solo este binario y sus dependencias.
RUN cargo build --release -p prospector-orchestrator

# -----------------------------------------------------------------
# ETAPA 2: RUNTIME (Entorno de Ejecuci√≥n Ligero)
# -----------------------------------------------------------------
FROM debian:bookworm-slim

WORKDIR /app

# 2.1. Preparaci√≥n del Sistema Operativo
# - ca-certificates: Vital para llamadas HTTPS a Turso y Google
# - libssl3: Librer√≠a din√°mica requerida por el binario compilado
# - curl: Necesario para el Healthcheck y descarga del filtro
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get install -y ca-certificates libssl3 curl && \
    rm -rf /var/lib/apt/lists/*

# 2.2. Estructura de Archivos Est√°ticos
# Creamos el directorio donde vivir√° el filtro de Bloom
RUN mkdir -p public

# 2.3. Inyecci√≥n del Filtro UTXO (Estrategia Externa)
# Si se provee FILTER_URL en tiempo de build, se descarga.
# Si no, se crea un archivo vac√≠o para evitar crashes al arrancar.
ARG FILTER_URL=""
RUN if [ -n "$FILTER_URL" ]; then \
      echo "‚¨áÔ∏è Descargando filtro desde CDN..."; \
      curl -L -f -o public/utxo_filter.bin "$FILTER_URL"; \
    else \
      echo "‚ö†Ô∏è  FILTER_URL no provista. Generando placeholder vac√≠o."; \
      touch public/utxo_filter.bin; \
    fi

# 2.4. Instalaci√≥n del Binario (CORRECCI√ìN CR√çTICA DE RUTA)
# Nx y .cargo/config.toml redirigen la salida a 'dist/target'.
# Copiamos desde esa ubicaci√≥n espec√≠fica.
COPY --from=builder /usr/src/app/dist/target/release/orchestrator /usr/local/bin/orchestrator

# 2.5. Configuraci√≥n de Entorno
ENV RUST_LOG=info
ENV PORT=3000

# Exposici√≥n de puerto (Documentaci√≥n para Docker)
EXPOSE 3000

# 2.6. Monitor de Salud (Healthcheck)
# Render/Docker usar√°n esto para saber si el contenedor est√° listo.
HEALTHCHECK --interval=30s --timeout=5s --start-period=5s \
  CMD curl -f http://localhost:3000/api/v1/status || exit 1

# 2.7. Comando de Inicio
CMD ["orchestrator"]
